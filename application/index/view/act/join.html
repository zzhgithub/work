<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="width=device-width,user-scalable=no,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"
          name="viewport"/>
    <title>title</title>
    <link href="/static/css/style.css" type="text/css" rel="stylesheet"/>
    <script src="/static/js/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="/static/js/global.js" type="text/javascript"></script>
</head>
<body class="light">
{include file="public/header" /}

<!--活动报名-->
<div class="activity_submit">
    <div class="activity_title">
        <dt><img src="{$data.img}"/></dt>
        <h4>{$data.name}</h4>
        <p>{$data.des|mb_substr=0,40,'UTF-8'}</p>
    </div>
    <div class="activity_inpu"><label>姓名：</label><input type="text" name="name" value=""/></div>
    <div class="activity_inpu"><label>电话：</label><input type="text" name="phone" value=""/></div>
    {:token()}
    <input type="hidden" name="id" data-id="{$data.id}">
    <input type="button" class="define" value="确定"/>
</div>
<!--layer-->
<div id="layer">
    {if condition="$data['isfree'] eq 1"}
    <!--免费报名-->
    <div class="layer">
        <h4>提示<span></span></h4>
        <p class="layer_m">恭喜你报名成功！</p>
    </div>
    {else/}
    <!--支付报名-->
    <div class="layer">
        <h4>提示<span></span></h4>
        <p class="layer_tow">恭喜你报名成功，<br/>请前往支付页面！</p>
        <a href="/act/dojoin/">去支付</a>
    </div>
    {/if}
</div>
{include file="public/footer" /}
<script>
    function alertMsg(msg) {
        var layer = $('.layer');
        var is_free = {$data['isfree']};
        var className = is_free ? 'layer_m':'layer_tow';
        layer.find('p').addClass(className).html(msg);
        layer.find('a').hide();
        $('#layer').show();
    }

    var flag = true;
    $(function () {
        $('.define').on('click', function () {
            if (!flag){
                return false;
            }
            flag = false;
            var id = $('input[name="id"]').data('id');
            var name = $('input[name="name"]').val();
            var phone = $('input[name="phone"]').val();
            var token = $('input[name="__token__"]').val();
            var chinese = /^[\u4E00-\u9FFF]+$/;

            if (!token) {
                alertMsg('页面异常');
                return false;
            }
            if (!id) {
                alertMsg('页面异常');
                return false;
            }
            if (!name || !chinese.test(name) || name.length < 2) {
                alertMsg('请输入正确的姓名');
                return false;
            }
            if (!phone || phone.length != 11 || phone[0] != 1) {
                alertMsg('请输入正确的手机号码');
                return false;
            }

            //  提交表单信息
            $.ajax({
                type: 'post',
                url: "/act/dojoin",
                data: {'name': name, 'phone': phone, 'id': id, '__token__': token},
                dataType: "json",
                success: function (data) {
                    if(data.code > 0){
                        flag = true;
                        callPay();
                    }else{

                    }
                }
            });
        });
    });

    function onBridgeReady(){
        WeixinJSBridge.invoke(
            'getBrandWCPayRequest', {
                "appId":"wx2421b1c4370ec43b",     //公众号名称，由商户传入
                "timeStamp":"1395712654",         //时间戳，自1970年以来的秒数
                "nonceStr":"e61463f8efa94090b1f366cccfbbb444", //随机串
                "package":"prepay_id=u802345jgfjsdfgsdg888",
                "signType":"MD5",         //微信签名方式：
                "paySign":"70EA570631E4BB79628FBCA90534C63FF7FADD89" //微信签名
            },
            function(res){
                if(res.err_msg == "get_brand_wcpay_request:ok" ) {

                }     // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。
            }
        );
    }

    function callPay() {
        if (typeof WeixinJSBridge == "undefined"){
            if( document.addEventListener ){
                document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
            }else if (document.attachEvent){
                document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
            }
        }else{
            onBridgeReady();
        }
    }
</script>
</body>
</html>